(window.webpackJsonp=window.webpackJsonp||[]).push([[17],{398:function(t,n,a){"use strict";a.r(n);var s=a(10),e=Object(s.a)({},(function(){var t=this,n=t.$createElement,a=t._self._c||n;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"問題"}},[t._v("問題")]),t._v(" "),a("p",[t._v("這篇使用的 grpc-go 版本是 "),a("code",[t._v("v1.20.1")]),t._v(":")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("# go.mod\n...\ngoogle.golang.org/grpc v1.20.1\n")])])]),a("p",[t._v("一般來說，client 在 dial 到 server 的時候，通常會設定一個 timeout 時間然後處理 timeout error。\n而 Go 在設定 timeout 通常是利用 "),a("a",{attrs:{href:"https://pkg.go.dev/context?tab=doc",target:"_blank",rel:"noopener noreferrer"}},[t._v("context"),a("OutboundLink")],1),t._v(" 的\n"),a("a",{attrs:{href:"https://pkg.go.dev/context?tab=doc#WithTimeout",target:"_blank",rel:"noopener noreferrer"}},[t._v("WithTimeout"),a("OutboundLink")],1),t._v(" 或者\n"),a("a",{attrs:{href:"https://pkg.go.dev/context?tab=doc#WithDeadline",target:"_blank",rel:"noopener noreferrer"}},[t._v("WithDeadline"),a("OutboundLink")],1),t._v(" 來設定。")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://pkg.go.dev/google.golang.org/grpc?tab=doc",target:"_blank",rel:"noopener noreferrer"}},[t._v("grpc-go"),a("OutboundLink")],1),t._v(" 提供了\n"),a("a",{attrs:{href:"https://pkg.go.dev/google.golang.org/grpc?tab=doc#DialContext",target:"_blank",rel:"noopener noreferrer"}},[t._v("DialContext"),a("OutboundLink")],1),t._v("\n讓使用者可以傳入一個 context.Context，而我也就很自然地寫了這樣的 code:")]),t._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" cancel "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" context"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("WithTimeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("context"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Background")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" time"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Minute"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nconn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" grpc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("DialContext")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" targetUri"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" grpc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("WithInsecure")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// handle error")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// handle conn")]),t._v("\n")])])]),a("p",[t._v("這樣寫會有什麼問題呢？其實沒什麼太大的問題，因為 grpc-go 會很貼心地幫你處理底層的連線：\n在需要的時候才建立連線，或者幫你重新連線。"),a("strong",[t._v("真貼心！")]),t._v(" 換句話說，這邊的 DialContext 其實並不會立刻去建立連線。")]),t._v(" "),a("blockquote",[a("p",[t._v("DialContext creates a client connection to the given target.\nBy default, it’s a non-blocking dial (the function won’t wait for connections to be established,\nand connecting happens in the background)")])]),t._v(" "),a("p",[t._v("因為 DialContext 並不是立刻去建立連線，所以傳入的 ctx 所設定的 timeout 並不是針對「建立連線」所設定的 timeout，\n而是僅對於 DialContext 這個 function call 的 timeout 而已。對於想要控制 dial timeout 的使用者來說，\n這邊的 ctx 根本是有設定等於沒設定… 這時候就要搭配 "),a("a",{attrs:{href:"https://pkg.go.dev/google.golang.org/grpc?tab=doc#WithBlock",target:"_blank",rel:"noopener noreferrer"}},[t._v("grpc.WithBlock()"),a("OutboundLink")],1),t._v(" 服用。")]),t._v(" "),a("blockquote",[a("p",[t._v("To make it a blocking dial, use WithBlock() dial option.")])]),t._v(" "),a("p",[t._v("個人覺得這個 default 真是設定的莫名其妙，就不能 default blocking 嗎？\n想當然爾"),a("a",{attrs:{href:"https://github.com/grpc/grpc-go/issues/1953",target:"_blank",rel:"noopener noreferrer"}},[t._v("有人也有一樣的疑問"),a("OutboundLink")],1),t._v("，可是看完討論還是覺得這個決定很莫名妙。")]),t._v(" "),a("h2",{attrs:{id:"解法"}},[t._v("解法")]),t._v(" "),a("p",[t._v("所以上面的 code 有兩種改法：")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("放棄 timeout/deadline/cancel，只用 context.Background() 或者 context.TODO()")]),t._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[t._v("conn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" grpc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("DialContext")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("context"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Background")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" targetUri"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" grpc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("WithInsecure")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// handle error")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// handle conn")]),t._v("\n")])])])]),t._v(" "),a("li",[a("p",[t._v("使用 grpc.WithBlock()")]),t._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" cancel "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" context"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("WithTimeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("context"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Background")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" time"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Minute"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nconn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" grpc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("DialContext")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" targetUri"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" grpc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("WithInsecure")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" grpc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("WithBlock")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// handle error")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// handle conn")]),t._v("\n")])])])])]),t._v(" "),a("h2",{attrs:{id:"總結"}},[t._v("總結")]),t._v(" "),a("p",[t._v("RTFM")])])}),[],!1,null,null,null);n.default=e.exports}}]);