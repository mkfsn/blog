<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>TIL: Go HTTP client reuse connection | mkfsn&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.5.2">
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=UA-124207676-2"></script>
    <script>window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-124207676-2', {'page_path': '/blog'});</script>
    <link rel="alternate" type="application/rss+xml" href="https://mkfsn.github.io/blog/rss.xml" title="mkfsn&#39;s Blog RSS Feed">
    <link rel="alternate" type="application/atom+xml" href="https://mkfsn.github.io/blog/feed.atom" title="mkfsn&#39;s Blog Atom Feed">
    <meta name="description" content="I was recently working on a weird problem related to the build-in net/http package.">
    <link rel="preload" href="/blog/assets/css/0.styles.2e3e263a.css" as="style"><link rel="preload" href="/blog/assets/js/app.2e5c185b.js" as="script"><link rel="preload" href="/blog/assets/js/6.d0ea2cd2.js" as="script"><link rel="preload" href="/blog/assets/js/3.5262f174.js" as="script"><link rel="preload" href="/blog/assets/js/17.03cd2c7d.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.a710a048.js"><link rel="prefetch" href="/blog/assets/js/11.2ef13787.js"><link rel="prefetch" href="/blog/assets/js/12.f5a2660b.js"><link rel="prefetch" href="/blog/assets/js/13.6843fd6a.js"><link rel="prefetch" href="/blog/assets/js/14.c0104bda.js"><link rel="prefetch" href="/blog/assets/js/15.887b75e7.js"><link rel="prefetch" href="/blog/assets/js/16.f5bb58ae.js"><link rel="prefetch" href="/blog/assets/js/18.d1dcf866.js"><link rel="prefetch" href="/blog/assets/js/19.3c1f9b3d.js"><link rel="prefetch" href="/blog/assets/js/20.9d44824a.js"><link rel="prefetch" href="/blog/assets/js/21.d15d14bc.js"><link rel="prefetch" href="/blog/assets/js/4.5972272e.js"><link rel="prefetch" href="/blog/assets/js/5.0400a4cb.js"><link rel="prefetch" href="/blog/assets/js/7.4023ea9b.js"><link rel="prefetch" href="/blog/assets/js/8.855989e8.js"><link rel="prefetch" href="/blog/assets/js/9.59a7ad92.js"><link rel="prefetch" href="/blog/assets/js/vuejs-paginate.6688bb33.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.2e3e263a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/blog/" class="nav-link home-link">mkfsn's Blog </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/blog/" class="nav-link">Blog</a></li><li class="nav-item"><a href="/blog/tag/" class="nav-link">Tags</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <a href="/rss.xml" class="feed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/blog/" class="nav-link mobile-home-link">mkfsn's Blog </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/blog/" class="nav-link">Blog</a></li><li class="mobile-nav-item"><a href="/blog/tag/" class="nav-link">Tags</a></li> <li class="mobile-nav-item"><a href="/rss.xml" class="feed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        TIL: Go HTTP client reuse connection
      </h1> <div class="post-meta"><div itemprop="publisher author" itemtype="http://schema.org/Person" itemscope="itemscope" class="post-meta-author"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-navigation"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg> <span itemprop="name">mkfsn</span> <!----></div> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2019-12-14T00:00:00.000Z">
      Sat Dec 14 2019
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-d832e844><a href="/blog/tag/golang" data-v-d832e844> golang </a></li><li class="post-tag" data-v-d832e844><a href="/blog/tag/http" data-v-d832e844> http </a></li><li class="post-tag" data-v-d832e844><a href="/blog/tag/http client" data-v-d832e844> http client </a></li><li class="post-tag" data-v-d832e844><a href="/blog/tag/http request" data-v-d832e844> http request </a></li><li class="post-tag" data-v-d832e844><a href="/blog/tag/race condition" data-v-d832e844> race condition </a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><h2 id="how-to-reuse-http-client-s-connection">How to reuse HTTP client’s connection?</h2> <p>As described in <a href="https://godoc.org/net/http#Client.Do" target="_blank" rel="noopener noreferrer">godoc<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, by default the http.Client would reuse the TCP connection,
but only if you read all the data from the http.Response Body and close the http.Response Body as well:</p> <blockquote><p>If the returned error is nil, the Response will contain a non-nil Body which the user is expected to close.
If the Body is not both read to EOF and closed, the Client’s underlying RoundTripper (typically Transport) may not
be able to re-use a persistent TCP connection to the server for a subsequent “keep-alive” request.</p></blockquote> <p>To disable reuse of the connection, one could:</p> <ol><li>Set <a href="https://godoc.org/net/http#Request" target="_blank" rel="noopener noreferrer">http.Response<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> Close to true</li> <li>Use <a href="https://godoc.org/net/http#Transport" target="_blank" rel="noopener noreferrer">http.Transport<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> and set DisableKeepAlives to true</li></ol> <p>But still, it is recommended to reuse the connection, it saves some time and resources to establish a new connection.</p> <h2 id="if-the-server-closes-the-reused-connection-on-the-client-side">If the server closes the reused connection on the client-side?</h2> <p>OK, now we all know that by default the connection won’t be easily closed in the client-side,
but what if the server closes that connection?</p> <p>Unfortunately, the error handling is not very ideal in the current implementation (Go 1.12 and Go 1.13).
All you’ll get is an EOF error, which is caused by reading the data from the connection buffer.</p> <p>This EOF error is actually a <strong>transportReadFromServerError</strong> when *persistConn is processing it:
<a href="https://github.com/golang/go/blob/release-branch.go1.12/src/net/http/transport.go#L1625" target="_blank" rel="noopener noreferrer">https://github.com/golang/go/blob/release-branch.go1.12/src/net/http/transport.go#L1625<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>But back to the *Transport, it only returns the wrapped error (the EOF):
<a href="https://github.com/golang/go/blob/ecde0bfa1fb11328133bb335af80fc2a48a8f82a/src/net/http/transport.go#L574" target="_blank" rel="noopener noreferrer">https://github.com/golang/go/blob/ecde0bfa1fb11328133bb335af80fc2a48a8f82a/src/net/http/transport.go#L574<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>In the end, the user would only receive an *url.Error which is generated by the
<a href="https://github.com/golang/go/blob/ecde0bfa1fb11328133bb335af80fc2a48a8f82a/src/net/http/client.go#L588" target="_blank" rel="noopener noreferrer">uerr<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
anonymous function, but just contains an EOF error.</p> <h2 id="tragedy-the-race-condition">Tragedy: the race condition</h2> <p>The weird problem I have recently is related to the two descriptions above.</p> <p>In my service, we send data periodically to the external database every n seconds,
and the connections have been reuse without a problem, but:</p> <blockquote><p>The server closes the idle connection after n seconds</p></blockquote> <p>And then, here comes the race condition …</p> <p>What would the client do first:</p> <ol><li>It founds out the connection has been closed by the server</li> <li>It tries to send the data to the external database</li></ol> <p>Of course, there’s no problem for the first case, the client would just open a new connection,
and my data is sent via this new connection — everything is just fine.</p> <p>However, if it tries to send the data first, then for sure the data won’t be stored into the database,
but even worse — you only get an EOF error. What the hell does that EOF mean!</p> <h2 id="the-solution-hotfix-or-workaround">The solution, hotfix, or workaround</h2> <p>As simple as you could imagine: Retry.</p> <p>It’s just making no sense to receive an EOF error, or more precisely — an *url.Error.</p></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#how-to-reuse-http-client-s-connection" title="How to reuse HTTP client’s connection?">How to reuse HTTP client’s connection?</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#if-the-server-closes-the-reused-connection-on-the-client-side" title="If the server closes the reused connection on the client-side?">If the server closes the reused connection on the client-side?</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#tragedy-the-race-condition" title="Tragedy: the race condition">Tragedy: the race condition</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#the-solution-hotfix-or-workaround" title="The solution, hotfix, or workaround">The solution, hotfix, or workaround</a></div></div></div></div> <footer class="footer" data-v-fdbf4940><div class="footer-left-wrap" data-v-fdbf4940><ul class="contact" data-v-fdbf4940><li class="contact-item" data-v-fdbf4940><a href="https://github.com/mkfsn" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-fdbf4940><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-fdbf4940><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-fdbf4940></path></svg>
          
        </a></li><li class="contact-item" data-v-fdbf4940><a href="https://gitlab.com/mkfsn" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-fdbf4940><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-gitlab" data-v-fdbf4940><path d="M22.65 14.39L12 22.13 1.35 14.39a.84.84 0 0 1-.3-.94l1.22-3.78 2.44-7.51A.42.42 0 0 1 4.82 2a.43.43 0 0 1 .58 0 .42.42 0 0 1 .11.18l2.44 7.49h8.1l2.44-7.51A.42.42 0 0 1 18.6 2a.43.43 0 0 1 .58 0 .42.42 0 0 1 .11.18l2.44 7.51L23 13.45a.84.84 0 0 1-.35.94z" data-v-fdbf4940></path></svg>
          
        </a></li><li class="contact-item" data-v-fdbf4940><a href="https://linkedin.com/in/mkfsn" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-fdbf4940><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-linkedin" data-v-fdbf4940><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z" data-v-fdbf4940></path><rect x="2" y="9" width="4" height="12" data-v-fdbf4940></rect><circle cx="4" cy="4" r="2" data-v-fdbf4940></circle></svg>
          
        </a></li><li class="contact-item" data-v-fdbf4940><a href="https://twitter.com/mkfsn" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-fdbf4940><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-twitter" data-v-fdbf4940><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z" data-v-fdbf4940></path></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-fdbf4940><ul class="copyright" data-v-fdbf4940><li class="copyright-item" data-v-fdbf4940><a href="https://policies.google.com/privacy?hl=en-US" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-fdbf4940>Privacy Policy</a></li></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.2e5c185b.js" defer></script><script src="/blog/assets/js/6.d0ea2cd2.js" defer></script><script src="/blog/assets/js/3.5262f174.js" defer></script><script src="/blog/assets/js/17.03cd2c7d.js" defer></script>
  </body>
</html>
